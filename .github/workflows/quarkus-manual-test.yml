name: Quarkus Manual Test

on:
  workflow_dispatch:

jobs:
  test:
    runs-on: ubuntu-latest

    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: postgres
          POSTGRES_DB: quarkus
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: Cache Maven dependencies
        uses: actions/cache@v4
        with:
          path: ~/.m2/repository
          key: ${{ runner.os }}-maven-${{ hashFiles('**/pom.xml') }}
          restore-keys: |
            ${{ runner.os }}-maven-

      - name: Initialize database
        run: |
          docker exec -i ${{ job.services.postgres.id }} psql -U postgres -d quarkus -c "CREATE TABLE users (id SERIAL PRIMARY KEY, username VARCHAR(255) UNIQUE NOT NULL, password VARCHAR(255) NOT NULL, name VARCHAR(255), age INTEGER);"
          docker exec -i ${{ job.services.postgres.id }} psql -U postgres -d quarkus -c "INSERT INTO users (username, password, name, age) VALUES ('john2', '\$2a$10\$S2j5z6f3Qz1b6k3v9t5r8u7v9w3x4y5z6a7b8c9d0e1f2g3h4i5j6', 'John Doe', 30);"
        env:
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: postgres

      - name: Build and Test with Maven
        env:
          QUARKUS_DATASOURCE_JDBC_URL: jdbc:postgresql://127.0.0.1:${{ job.services.postgres.ports[5432] }}/quarkus
          QUARKUS_DATASOURCE_USERNAME: postgres
          QUARKUS_DATASOURCE_PASSWORD: postgres
        run: mvn clean verify

      - name: Start Quarkus application
        env:
          QUARKUS_DATASOURCE_JDBC_URL: jdbc:postgresql://127.0.0.1:${{ job.services.postgres.ports[5432] }}/quarkus
          QUARKUS_DATASOURCE_USERNAME: postgres
          QUARKUS_DATASOURCE_PASSWORD: postgres
        run: mvn quarkus:dev -Dquarkus.http.host=0.0.0.0 &

      - name: Wait for application
        run: timeout 60s bash -c "while ! curl -s http://localhost:9090 > /dev/null; do sleep 1; done"

      - name: Run k6 load tests
        uses: grafana/k6-action@v0.3.0
        with:
          filename: load-test.js
